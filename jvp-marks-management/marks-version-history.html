<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Jamna Vidyapeeth - Marks Version History</title>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
      <!-- Supabase CRUD Functions -->
      <script type="module" src="supabase-crud.js"></script>
      <style>
         :root {
         --primary: #4f46e5;
         --primary-dark: #4338ca;
         --secondary: #10b981;
         --secondary-dark: #059669;
         --danger: #ef4444;
         --danger-dark: #c33c3c;
         --light: #f9fafb;
         --dark: #1f2937;
         --text: #374151;
         --border: #e5e7eb;
         --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
         --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
         --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
         --transition: all 0.2s ease;
         }
         * {
         margin: 0;
         padding: 0;
         box-sizing: border-box;
         font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
         max-height: 9999999px;
         }
         body {
         background-color: var(--light);
         color: var(--text);
         line-height: 1.6;
         font-size: 16px;
         }
         .container {
         max-width: 1200px;
         margin: 0 auto;
         padding: 20px;
         }
         header {
         background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
         color: white;
         padding: 24px 0;
         text-align: center;
         box-shadow: var(--shadow);
         margin-bottom: 2rem;
         }
         h1 {
         margin: 0;
         font-size: 1.5rem;
         font-weight: 700;
         letter-spacing: -0.025em;
         }
         h2 {
         color: var(--dark);
         font-size: 1.75rem;
         font-weight: 700;
         margin-bottom: 1.5rem;
         letter-spacing: -0.025em;
         }
         h3 {
         color: var(--dark);
         font-size: 1.25rem;
         font-weight: 600;
         margin-bottom: 1rem;
         letter-spacing: -0.025em;
         }
         .login-container, .app-container {
         background-color: white;
         border-radius: 12px;
         box-shadow: var(--shadow-lg);
         padding: 36px;
         margin: 30px auto;
         max-width: 800px;
         border: 1px solid var(--border);
         }
         .login-container {
         max-width: 440px;
         } 
         .form-group {
         margin-bottom: 24px;
         }
         label {
         display: block;
         font-weight: 600;
         margin-bottom: 8px;
         color: var(--dark);
         font-size: 0.9rem;
         }
         input, select {
         width: 100%;
         padding: 12px 16px;
         border: 1px solid var(--border);
         border-radius: 8px;
         font-size: 16px;
         transition: var(--transition);
         color: var(--text);
         background-color: var(--light);
         box-sizing: border-box;
         }
         input:focus, select:focus {
         outline: none;
         border-color: var(--primary);
         box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
         }
         input[type="number"] {
         width: 80px;
         }
         button {
         background-color: var(--primary);
         color: white;
         border: none;
         border-radius: 8px;
         padding: 12px 24px;
         font-size: 16px;
         cursor: pointer;
         transition: var(--transition);
         font-weight: 600;
         box-shadow: var(--shadow-sm);
         }
         button:hover {
         background-color: var(--primary-dark);
         transform: translateY(-1px);
         box-shadow: var(--shadow);
         }
         button:active {
         transform: translateY(0);
         }
         .btn-secondary {
         background-color: var(--secondary);
         }
         .btn-secondary:hover {
         background-color: var(--secondary-dark);
         }
         .btn-logout {
         background-color: var(--danger);
         padding: 10px 20px;
         font-size: 14px;
         }
         .btn-logout:hover, #delete-btn:hover, #cancelReportDialog:hover {
         background-color: var(--danger-dark);
         }
         .loading-overlay {
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         background-color: rgba(255, 255, 255, 0.8);
         backdrop-filter: blur(4px);
         display: flex;
         justify-content: center;
         align-items: center;
         z-index: 9999;
         }
         .spinner {
         width: 60px;
         height: 60px;
         border: 6px solid rgba(79, 70, 229, 0.3);
         border-radius: 50%;
         border-top-color: var(--primary);
         animation: spin 1s ease-in-out infinite;
         }
         .hidden {
         display: none;
         }
         @keyframes spin {
         to { transform: rotate(360deg); }
         }
         /* School header styles */
         .school-header {
         display: flex;
         align-items: center;
         justify-content: center;
         gap: 20px;
         }
         .school-logo {
         height: 80px;
         border-radius: 50%;
         background-color: white;
         padding: 5px;
         box-shadow: var(--shadow);
         }
         .school-info {
         text-align: left;
         }
         .school-name {
         font-size: 2.5rem;
         margin-bottom: 5px;
         }
         .system-name {
         font-size: 1.5rem;
         color: rgba(255, 255, 255, 0.9);
         font-weight: 500;
         margin: 0;
         }
         .user-info {
         align-items: center;
         justify-content: center; 
         margin-top: 16px;
         }
         .user-avatar {
         color: white;        
         font-size: 36px;
         }
         #signed-in-username {
         margin-left: 6px;
         color: white;
         }
         /* Input group with domain suffix */
         .input-group {
         position: relative;
         }
         .input-group input {
         padding-right: 90px; /* space for the suffix */
         }
         .domain-suffix {
         position: absolute;
         right: 16px;
         top: 50%;
         transform: translateY(-50%);
         color: #888;
         font-size: 14px;
         pointer-events: none;
         user-select: none;
         }
         /* Alert styling */
         .alert {
         background-color: #fee2e2;
         color: var(--danger-dark);
         padding: 12px 16px;
         border-radius: 8px;
         margin-bottom: 20px;
         font-weight: 500;
         }
         /* Header with actions */
         .header-with-actions {
         display: flex;
         justify-content: space-between;
         align-items: center;
         margin-bottom: 24px;
         }
         .header-actions {
         display: flex;
         gap: 12px;
         }
         /* Timeline styles */
         .timeline-container {
         margin-top: 40px;
         }
         .timeline-group {
         margin-bottom: 40px;
         background-color: white;
         border-radius: 12px;
         padding: 24px;
         box-shadow: var(--shadow);
         border: 1px solid var(--border);
         }
         .timeline-group-header {
         margin-bottom: 20px;
         border-bottom: 1px solid var(--border);
         padding-bottom: 16px;
         }
         .timeline-group-header h3 {
         margin-bottom: 6px;
         color: var(--primary);
         }
         .timeline-group-header p {
         font-size: 15px;
         color: var(--text);
         opacity: 0.8;
         }
         .timeline-entries {
         position: relative;
         padding-left: 32px;
         }
         .timeline-entries::before {
         content: '';
         position: absolute;
         top: 0;
         bottom: 0;
         left: 8px;
         width: 2px;
         background-color: var(--primary);
         opacity: 0.3;
         }
         .timeline-entry {
         position: relative;
         padding: 16px 0;
         border-bottom: 1px dashed var(--border);
         }
         .timeline-entry:last-child {
         border-bottom: none;
         }
         .timeline-entry::before {
         content: '';
         position: absolute;
         left: -24px;
         top: 20px;
         width: 14px;
         height: 14px;
         border-radius: 50%;
         background-color: var(--primary);
         border: 3px solid white;
         box-shadow: var(--shadow-sm);
         }
         .timeline-entry.current::before {
         background-color: var(--secondary);
         }
         .entry-date {
         font-size: 0.8rem;
         color: var(--text);
         opacity: 0.7;
         margin-bottom: 6px;
         }
         .entry-content {
         display: flex;
         justify-content: space-between;
         align-items: center;
         }
         .entry-marks {
         font-size: 1.2rem;
         font-weight: 600;
         color: var(--primary-dark);
         background-color: rgba(79, 70, 229, 0.1);
         padding: 8px 16px;
         border-radius: 8px;
         min-width: 60px;
         text-align: center;
         }
         .entry-marks.null {
         color: var(--danger);
         background-color: rgba(239, 68, 68, 0.1);
         }
         .entry-id {
         font-size: 0.75rem;
         color: var(--text);
         opacity: 0.5;
         margin-top: 8px;
         word-break: break-word;
         overflow-wrap: break-word;
         }
         /* Search and filter styles */
         .filter-container {
         display: flex;
         flex-wrap: wrap;
         gap: 16px;
         margin-bottom: 24px;
         }
         .filter-group {
         flex: 1;
         min-width: 200px;
         }
         .filter-group label {
         margin-bottom: 4px;
         }
         .search-container {
         position: relative;
         flex: 2;
         }
         .search-container input {
         padding-left: 40px;
         }
         .search-icon {
         position: absolute;
         left: 12px;
         top: 50%;
         transform: translateY(-50%);
         color: var(--text);
         opacity: 0.5;
         }
         /* Responsive styles */
         @media (max-width: 768px) {
         .school-header {
         flex-direction: column;
         gap: 10px;
         }
         .school-info {
         text-align: center;
         }
         .school-name {
         font-size: 1.8rem;
         }
         .system-name {
         font-size: 1.2rem;
         }
         #signed-in-username {
         margin-left: 3px;
         }
         .header-with-actions {
         flex-direction: column;
         gap: 16px;
         align-items: flex-start;
         }
         .header-actions {
         width: 100%;
         }
         .filter-container {
         flex-direction: column;
         }
         }
      </style>
   </head>
   <body>
      <header>
         <div class="container">
            <div class="school-header">
               <img src="https://i.postimg.cc/Y0qB2Wyc/images-2024-05-21-T183208-408.jpg" alt="Jamna Vidyapeeth Logo" class="school-logo">
               <div class="school-info">
                  <h1 class="school-name">Jamna Vidyapeeth</h1>
                  <h2 class="system-name">Student Marks Management System</h2>
               </div>
            </div>
            <div style="display: none" id="user-info" class="user-info">
               <span class="user-avatar material-icons">account_circle</span>
               <span id="signed-in-username">Sourabh</span>
            </div>
         </div>
      </header>
      <div class="container">
         <!-- Loading Overlay -->
         <div id="loading-overlay" class="loading-overlay hidden">
            <div class="spinner"></div>
         </div>
         <!-- Login Section -->
         <div id="login-section" class="login-container">
            <h2>Teacher Login</h2>
            <div id="login-error" class="alert hidden"></div>
            <div class="form-group">
               <label for="username">Username</label>
               <div class="input-group">
                  <input type="text" id="username" placeholder="Enter your username">
                  <span class="domain-suffix">@jvp.com</span>
               </div>
            </div>
            <div class="form-group">
               <label for="password">Password</label>
               <input type="password" id="password" placeholder="Enter your password">
            </div>
            <button id="login-btn" class="btn-secondary">Login</button>
         </div>
         <!-- App Section (Hidden by default) -->
         <div id="app-section" class="app-container hidden">
            <div class="header-with-actions">
               <h2>Marks Version History</h2>
               <div class="header-actions">
                  <button id="logout-btn" class="btn-logout">Logout</button>
               </div>
            </div>
            <!-- Search and Filter Controls -->
            <div class="filter-container">
               <div class="search-container">
                  <span class="material-icons search-icon">search</span>
                  <input type="text" id="search-input" placeholder="Search by name or class...">
               </div>
               <div class="filter-group">
                  <label for="filter-class">Filter by Class</label>
                  <select id="filter-class">
                     <option value="">All Classes</option>
                  </select>
               </div>
               <div class="filter-group">
                  <label for="filter-exam">Filter by Exam</label>
                  <select id="filter-exam">
                     <option value="">All Exams</option>
                  </select>
               </div>
            </div>
            <!-- Timeline Content -->
            <div id="timeline-content" class="timeline-container">
               <!-- Timeline groups will be inserted here by JavaScript -->
            </div>
         </div>
      </div>
      <script>
         // DOM Elements
         const loginSection = document.getElementById('login-section');
         const appSection = document.getElementById('app-section');
         const usernameInput = document.getElementById('username');
         const passwordInput = document.getElementById('password');
         const loginBtn = document.getElementById('login-btn');
         const loginError = document.getElementById('login-error');
         const logoutBtn = document.getElementById('logout-btn');
         const loadingOverlay = document.getElementById('loading-overlay');
         const timelineContent = document.getElementById('timeline-content');
         const searchInput = document.getElementById('search-input');
         const filterClass = document.getElementById('filter-class');
         const filterExam = document.getElementById('filter-exam');
         const userInfo = document.getElementById('user-info');
         const signedInUsername = document.getElementById('signed-in-username');
         
         // Marks history data (will be loaded from server)
         let marks_history = [];
         
         // Helper functions
         function showLoading() {
             loadingOverlay.classList.remove('hidden');
         }
         
         function hideLoading() {
             loadingOverlay.classList.add('hidden');
         }
         
         function formatDate(dateString) {
             const date = new Date(dateString);
             return date.toLocaleString('en-IN', { 
                 day: '2-digit',
                 month: 'short', 
                 year: 'numeric',
                 hour: '2-digit',
                 minute: '2-digit',
                 hour12: true
             });
         }
         
         // Function to group marks history by student + exam + class
         function groupMarksByUniqueIdentifier(marksData) {
             // Create a unique identifier for each student-exam-class combination
             const groups = {};
             
             marksData.forEach(entry => {
                 const key = `${entry.student}_${entry.exam}_${entry.class}_${entry.subject}`;
                 
                 if (!groups[key]) {
                     groups[key] = {
                         id: entry.id,
                         student: entry.student,
                         exam: entry.exam,
                         class: entry.class,
                         subject: entry.subject,
                         entries: []
                     };
                 }
                 
                 groups[key].entries.push(entry);
             });
             
             // Sort entries within each group by timestamp (newest first)
             Object.values(groups).forEach(group => {
                 group.entries.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
             });
             
             return Object.values(groups);
         }
         
         // Render the timeline
         function renderTimeline(marksData) {
             // Group marks by unique identifier
             const groups = groupMarksByUniqueIdentifier(marksData);
             
             // Clear the timeline content
             timelineContent.innerHTML = '';
             
             // Exit if no data
             if (groups.length === 0) {
                 timelineContent.innerHTML = '<div class="timeline-group"><p>No marks history found.</p></div>';
                 return;
             }
             
             // Render each group
             groups.forEach(group => {
                 const groupEl = document.createElement('div');
                 groupEl.classList.add('timeline-group');
                 
                 // Create group header
                 const headerEl = document.createElement('div');
                 headerEl.classList.add('timeline-group-header');
                 headerEl.innerHTML = `
                     <h3>${group.student}</h3>
                     <p>${group.exam} | ${group.class} | ${group.subject}</p>
                 `;
                 
                 // Create timeline entries container
                 const entriesEl = document.createElement('div');
                 entriesEl.classList.add('timeline-entries');
                 
                 // Add each entry to the timeline
                 group.entries.forEach((entry, index) => {
                     const entryEl = document.createElement('div');
                     entryEl.classList.add('timeline-entry');
                     
                     // Mark the current (newest) entry
                     if (index === 0) {
                         entryEl.classList.add('current');
                     }
                     
                     // Format the entry
                     entryEl.innerHTML = `
                         <div class="entry-date">${formatDate(entry.updated_at)}</div>
                         <div class="entry-content">
                             <div>
                                 <div>Marks: <span class="entry-marks ${entry.marks === null ? 'null' : ''}">${entry.marks !== null ? entry.marks : 'N/A'}</span></div>
                                 <div class="entry-id">ID: ${entry.backup_id}</div>
                             </div>
                         </div>
                     `;
                     
                     entriesEl.appendChild(entryEl);
                 });
                 
                 // Add header and entries to the group
                 groupEl.appendChild(headerEl);
                 groupEl.appendChild(entriesEl);
                 
                 // Add the group to the timeline
                 timelineContent.appendChild(groupEl);
             });
         }
         
         // Populate filter dropdown options
         function populateFilterOptions(marksData) {
             // Get unique classes
             const classes = [...new Set(marksData.map(entry => entry.class))];
             filterClass.innerHTML = '<option value="">All Classes</option>';
             classes.forEach(cls => {
                 const option = document.createElement('option');
                 option.value = cls;
                 option.textContent = cls;
                 filterClass.appendChild(option);
             });
             
             // Get unique exams
             const exams = [...new Set(marksData.map(entry => entry.exam))];
             filterExam.innerHTML = '<option value="">All Exams</option>';
             exams.forEach(exam => {
                 const option = document.createElement('option');
                 option.value = exam;
                 option.textContent = exam;
                 filterExam.appendChild(option);
             });
         }
         
         // Filter marks data based on search and filter criteria
         function filterMarksData() {
             const searchTerm = searchInput.value.trim().toLowerCase();
             const selectedClass = filterClass.value;
             const selectedExam = filterExam.value;
             
             return marks_history.filter(entry => {
                 // Apply search filter
                 const matchesSearch = !searchTerm || 
                     entry.student.toLowerCase().includes(searchTerm) || 
                     entry.class.toLowerCase().includes(searchTerm);
                 
                 // Apply class filter
                 const matchesClass = !selectedClass || entry.class === selectedClass;
                 
                 // Apply exam filter
                 const matchesExam = !selectedExam || entry.exam === selectedExam;
                 
                 return matchesSearch && matchesClass && matchesExam;
             });
         }
         
         // Apply filters and update the timeline
         function applyFilters() {
             const filteredData = filterMarksData();
             renderTimeline(filteredData);
         }
         
         // Initialize the application
         async function initApp() {
         
             // Load marks history from server
             marks_history = await invokeFunction('get_multiple_marks_updates');
             // Populate filter options
             populateFilterOptions(marks_history);
             
             // Render the initial timeline
             renderTimeline(marks_history);
             
             // Set up event listeners for filters
             searchInput.addEventListener('input', applyFilters);
             filterClass.addEventListener('change', applyFilters);
             filterExam.addEventListener('change', applyFilters);
             
             // Show user info
             userInfo.style.display = 'flex';
         }
         
         // Check authentication status when the window loads
         window.addEventListener('load', async () => {
             showLoading();
             
             try {
                 const isAuthenticated = await checkAuth();
                 
                 if (isAuthenticated) {
                     // User is authenticated, show the app
                     
              // Fetch teacher's name
             const teacherName = await selectData('teachers', true, 'name', ['id'], [window.userId]);
             if (teacherName && typeof teacherName === 'object' && teacherName.name !== undefined) {
                signedInUsername.innerText = teacherName.name;
                userInfo.style.display = "flex";
             }
         
                     loginSection.classList.add('hidden');
                     appSection.classList.remove('hidden');
                     
                     // Initialize the app
                     initApp();
                 }
             } catch (error) {
                 console.error('Auth check error:', error);
             } finally {
                 hideLoading();
             }
         });
         
         // Login functionality
         loginBtn.addEventListener('click', async () => {
             const username = usernameInput.value.trim();
             const email = username.endsWith('@jvp.com') ? username : `${username}@jvp.com`;
             const password = passwordInput.value.trim();
             
             if (!email || !password) {
                 loginError.textContent = 'Please enter both email and password!';
                 loginError.classList.remove('hidden');
                 return;
             }
             
             showLoading();
             
             try {
                 // Use authentication
                 const data = await signInUser(email, password);
         
          // Store the user ID
          window.userId = data.user.id;
                 
                 // If we reach here, login was successful
                 loginSection.classList.add('hidden');
                 appSection.classList.remove('hidden');
                 loginError.classList.add('hidden');
                 
                 // Set username in the UI
          // Fetch teacher's name
          const teacherName = await selectData('teachers', true, 'name', ['id'], [window.userId]);
          if (teacherName && typeof teacherName === 'object' && teacherName.name !== undefined) {
             signedInUsername.innerText = teacherName.name;
             userInfo.style.display = "flex";
          }
                 
                 // Initialize the app
                 initApp();
                 
             } catch (error) {
                 // Handle login error
                 loginError.textContent = error.message || 'Invalid email or password!';
                 loginError.classList.remove('hidden');
             } finally {
                 hideLoading();
             }
         });
         
         // Logout functionality
         logoutBtn.addEventListener('click', async () => {
             showLoading();
             
             try {
                 await signOutUser();
                 
                 // Clear UI state
                 loginSection.classList.remove('hidden');
                 appSection.classList.add('hidden');
                 usernameInput.value = '';
                 passwordInput.value = '';
                 userInfo.style.display = 'none';
                 
             } catch (error) {
                 console.error('Logout error:', error);
             } finally {
                 hideLoading();
             }
         });
      </script>
   </body>
</html>